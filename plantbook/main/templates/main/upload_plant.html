{% extends 'main/base.html' %}
{% load static %}

{% block content %}
<main class="container">
    <div class="welcome-section">
        <h1>Add New Plant</h1>
        <p>Share your plant's details and photos</p>
    </div>

    <div class="upload-container">
        <h1>Upload Plant</h1>
        <form method="post" enctype="multipart/form-data" class="upload-form">
            {% csrf_token %}
            <div class="form-group">
                <label for="plant_name">Plant Name</label>
                <input type="text" id="plant_name" name="name" required autocomplete="off">
                <div id="plant-suggestions" class="suggestions-container"></div>
            </div>
            
            <div class="form-group">
                <label for="scientific_name">Scientific Name</label>
                <input type="text" id="scientific_name" name="scientific_name" required>
            </div>
            
            <div class="form-group">
                <label for="plant_image">Plant Image</label>
                <input type="file" id="plant_image" name="image" accept="image/*" required>
                <div id="image-preview" class="image-preview"></div>
            </div>
            
            <div class="plant-details-section">
                <h2>Plant Details</h2>
                <div id="details-container">
                    <div class="detail-entry">
                        <input type="text" name="detail_header[]" placeholder="Detail Header" required>
                        <textarea name="detail_information[]" placeholder="Detail Information" required></textarea>
                        <button type="button" class="btn-remove-detail" onclick="removeDetail(this)">Remove</button>
                    </div>
                </div>
                <button type="button" class="btn-add-detail" onclick="addDetail()">Add Detail</button>
            </div>
            
            <button type="submit" class="btn-submit">Upload Plant</button>
        </form>
    </div>
</main>

<style>
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1rem;
    }

    .welcome-section {
        text-align: center;
        padding: 3rem 1rem;
        background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('{% static "main/images/hero-bg.jpg" %}');
        background-size: cover;
        background-position: center;
        color: white;
        border-radius: 8px;
        margin: 2rem 0;
    }

    .welcome-section h1 {
        font-size: 2.5rem;
        margin-bottom: 1rem;
    }

    .welcome-section p {
        font-size: 1.2rem;
        margin-bottom: 2rem;
    }

    .upload-container {
        background: rgba(255, 255, 255, 0.8);
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }

    .upload-form {
        max-width: 800px;
        margin: 0 auto;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: #333;
        font-weight: 500;
    }

    .form-group input[type="text"],
    .form-group textarea {
        width: 100%;
        padding: 0.8rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
        box-sizing: border-box;
    }

    .form-group textarea {
        height: 100px;
        resize: vertical;
        min-height: 100px;
    }

    .image-preview {
        width: 100%;
        height: 200px;
        border: 2px dashed #ddd;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 1rem;
        overflow: hidden;
    }

    .image-preview img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }

    .image-preview i {
        font-size: 3rem;
        color: #ccc;
    }

    .plant-details {
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 1px solid #eee;
    }

    .plant-details h3 {
        margin-bottom: 1.5rem;
        color: #333;
        font-size: 1.5rem;
    }

    .detail-entry {
        background: #f9f9f9;
        padding: 1.5rem;
        border-radius: 4px;
        margin-bottom: 1rem;
        position: relative;
    }

    .remove-detail {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: none;
        border: none;
        color: #dc3545;
        cursor: pointer;
        font-size: 1.2rem;
    }

    .btn {
        display: inline-block;
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        text-decoration: none;
        transition: background-color 0.2s;
    }

    .btn-primary {
        background-color: #4CAF50;
        color: white;
        width: 100%;
    }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
        margin-bottom: 1rem;
    }

    .btn-primary:hover {
        background-color: #45a049;
    }

    .btn-secondary:hover {
        background-color: #5a6268;
    }

    #details-container {
        margin-bottom: 1rem;
    }

    .suggestions-container {
        position: absolute;
        width: 100%;
        max-height: 200px;
        overflow-y: auto;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-top: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        z-index: 1000;
        display: none;
    }

    .suggestion-item {
        padding: 0.75rem;
        cursor: pointer;
        border-bottom: 1px solid #eee;
    }

    .suggestion-item:hover {
        background-color: #f5f5f5;
    }

    .suggestion-item:last-child {
        border-bottom: none;
    }

    .plant-details-section {
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 1px solid #eee;
    }

    .plant-details-section h2 {
        color: #4CAF50;
        margin-bottom: 1rem;
    }

    .detail-entry {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
        align-items: flex-start;
    }

    .detail-entry input {
        flex: 1;
    }

    .detail-entry textarea {
        flex: 2;
        min-height: 100px;
        resize: vertical;
    }

    .btn-remove-detail {
        background: #dc3545;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .btn-remove-detail:hover {
        background: #c82333;
    }

    .btn-add-detail {
        background: #4CAF50;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
        width: 100%;
        margin-top: 1rem;
    }

    .btn-add-detail:hover {
        background: #45a049;
    }

    .btn-submit {
        background: #4CAF50;
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
        width: 100%;
        margin-top: 2rem;
        font-size: 1.1rem;
    }

    .btn-submit:hover {
        background: #45a049;
    }

    @media (max-width: 768px) {
        .upload-container {
            margin: 1rem;
            padding: 1rem;
        }

        .detail-entry {
            flex-direction: column;
        }

        .detail-entry textarea {
            width: 100%;
        }
    }
</style>

<script>
let searchTimeout;

function searchPlants(query) {
    if (query.length < 2) {
        document.getElementById('plant-suggestions').style.display = 'none';
        return;
    }

    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        fetch(`/search-plants/?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                const suggestionsContainer = document.getElementById('plant-suggestions');
                suggestionsContainer.innerHTML = '';
                
                if (data.data && data.data.length > 0) {
                    data.data.forEach(plant => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        div.textContent = `${plant.common_name} (${plant.scientific_name})`;
                        div.onclick = () => selectPlant(plant);
                        suggestionsContainer.appendChild(div);
                    });
                    suggestionsContainer.style.display = 'block';
                } else {
                    suggestionsContainer.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('plant-suggestions').style.display = 'none';
            });
    }, 300);
}

function selectPlant(plant) {
    document.getElementById('plant_name').value = plant.common_name || '';
    document.getElementById('scientific_name').value = plant.scientific_name || '';
    document.getElementById('plant-suggestions').style.display = 'none';

    // Add plant details from API
    const detailsContainer = document.getElementById('details-container');
    detailsContainer.innerHTML = ''; // Clear existing details

    // Add scientific name if available
    if (plant.scientific_name) {
        addDetail('Scientific Name', plant.scientific_name);
    }

    // Add family if available
    if (plant.family) {
        addDetail('Family', plant.family);
    }

    // Add genus if available
    if (plant.genus) {
        addDetail('Genus', plant.genus);
    }

    // Add species if available
    if (plant.species) {
        addDetail('Species', plant.species);
    }

    // Add year if available
    if (plant.year) {
        addDetail('Year', plant.year);
    }

    // Add bibliography if available
    if (plant.bibliography) {
        addDetail('Bibliography', plant.bibliography);
    }

    // Add author if available
    if (plant.author) {
        addDetail('Author', plant.author);
    }

    // Add status if available
    if (plant.status) {
        addDetail('Status', plant.status);
    }

    // Add rank if available
    if (plant.rank) {
        addDetail('Rank', plant.rank);
    }

    // Add image if available
    if (plant.image_url) {
        const imagePreview = document.getElementById('image-preview');
        imagePreview.innerHTML = `<img src="${plant.image_url}" alt="${plant.common_name}">`;
    }
}

function addDetail(header = '', information = '') {
    const detailsContainer = document.getElementById('details-container');
    const detailEntry = document.createElement('div');
    detailEntry.className = 'detail-entry';
    detailEntry.innerHTML = `
        <input type="text" name="detail_header[]" placeholder="Detail Header" value="${header}" required>
        <textarea name="detail_information[]" placeholder="Detail Information" required>${information}</textarea>
        <button type="button" class="btn-remove-detail" onclick="removeDetail(this)">Remove</button>
    `;
    detailsContainer.appendChild(detailEntry);
}

function removeDetail(button) {
    button.parentElement.remove();
}

// Image preview
document.getElementById('plant_image').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const imagePreview = document.getElementById('image-preview');
            imagePreview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
        }
        reader.readAsDataURL(file);
    }
});

// Close suggestions when clicking outside
document.addEventListener('click', function(e) {
    const suggestionsContainer = document.getElementById('plant-suggestions');
    const plantNameInput = document.getElementById('plant_name');
    
    if (!plantNameInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
        suggestionsContainer.style.display = 'none';
    }
});

// Add input event listener for plant name autocomplete
document.getElementById('plant_name').addEventListener('input', function(e) {
    searchPlants(e.target.value);
});
</script>
{% endblock %} 